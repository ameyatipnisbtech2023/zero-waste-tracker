<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Zero Waste Office Tracker</title>
<style>
    body {
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #f0f4f8, #d9fdd3);
        color: #333;
    }
    h1 { 
        text-align: center; 
        margin-top: 20px;
        color: #198754;
    }
    .container {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
    }

    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 20px;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        table-layout: fixed; /* ensures equal column sizing */
    }
    th, td {
        padding: 10px;
        border-bottom: 1px solid #eee;
        text-align: center;
        vertical-align: top;
        word-wrap: break-word;
    }
    th {
        background: #198754;
        color: white;
        text-transform: uppercase;
        font-size: 0.9em;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #e8f5e9; }

    /* Equal widths for 5 category columns */
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7),
    th:nth-child(8), td:nth-child(8),
    th:nth-child(9), td:nth-child(9),
    th:nth-child(10), td:nth-child(10) {
        width: 100px;
    }

    button {
        padding: 6px 14px;
        margin: 2px;
        border-radius: 25px;
        font-size: 0.9em;
        font-weight: bold;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .btn { background: #0d6efd; color: white; }
    .btn:hover { background: #0b5ed7; transform: translateY(-2px); }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #bb2d3b; transform: translateY(-2px); }
    .btn-save { background: #198754; color: white; }
    .btn-save:hover { background: #157347; transform: translateY(-2px); }

    select, input { width: 100%; }

    .export-section { margin-top: 20px; }

    .stats-card {
        flex: 1;
        text-align: center;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: transform 0.2s;
    }
    .stats-card:hover { transform: scale(1.05); }
    .stats-value {
        font-size: 2em;
        font-weight: bold;
        color: #198754;
    }

    .completion-cell {
        font-size: 1.2em;
        font-weight: bold;
    }
    .bar-container {
        position: relative;
        background: #eee;
        height: 18px;
        border-radius: 10px;
        overflow: hidden;
    }
    .bar-fill {
        height: 100%;
        transition: width 0.4s ease;
    }
    .bar-text {
        position: absolute;
        width: 100%;
        font-size: 11px;
        font-weight: bold;
        color: #fff;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        text-align: center;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 999;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(3px);
    }
    .modal-content {
        background: #fff;
        margin: 5% auto;
        padding: 20px;
        width: 80%;
        max-height: 80vh;      
        overflow-y: auto;      
        border-radius: 8px;
    }
    @keyframes zoomIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .close { float: right; font-size: 28px; cursor: pointer; }
</style>
</head>
<body>

<h1> Zero Waste Office Tracker</h1>

<!-- Stats Visualization -->
<div id="statsContainer" style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
  <div style="flex:1; text-align:center; background:#f8f9fa; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <div id="totalOffices" style="font-size:2em; color:green;">0</div>
    <div>Total Offices</div>
  </div>
  <div style="flex:1; text-align:center; background:#f8f9fa; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <div id="fullyImplemented" style="font-size:2em; color:green;">0</div>
    <div>Fully Implemented</div>
  </div>
  <div style="flex:1; text-align:center; background:#f8f9fa; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <div id="inProgress" style="font-size:2em; color:green;">0</div>
    <div>In Progress</div>
  </div>
  <div style="flex:1; text-align:center; background:#f8f9fa; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <div id="averageProgress" style="font-size:2em; color:green;">0%</div>
    <div>Average Progress</div>
  </div>
</div>

<button class="btn" onclick="openModal()">âž• Add New Office</button>

<div id="officeModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Add New Office</h2>
    <form id="officeForm">
      <label>Office Name</label><input type="text" name="officeName">
      <label>Department</label><input type="text" name="department">
      <label>Contact Person</label><input type="text" name="contactPerson">
      <label>Contact Email</label><input type="text" name="contactEmail">
      <label>Total Employees</label><input type="number" name="totalEmployees">
      <h3>Pantry</h3><div id="pantryInputs"></div>
      <h3>Restrooms</h3><div id="restroomsInputs"></div>
      <h3>Meeting Rooms</h3><div id="meetingRoomsInputs"></div>
      <h3>Events</h3><div id="eventsInputs"></div>
      <h3>Premises</h3><div id="premisesInputs"></div>
      <label>Certificate Date</label><input type="date" name="certificateDate">
      <br><br>
      <button type="button" class="btn-save" onclick="saveNewOffice()">Save Office</button>
    </form>
  </div>
</div>

<table id="officeTable">
<thead>
<tr>
    <th>Office Name</th><th>Department</th><th>Contact Person</th><th>Contact Email</th><th>Total Employees</th>
    <th>Pantry</th><th>Restrooms</th><th>Meeting Rooms</th><th>Events</th><th>Premises</th>
    <th>Certificate Date</th><th>Certification Status</th><th>Completion (%)</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="export-section">
    <button class="btn" onclick="exportToCSV()">ðŸ“Š Export to CSV</button>
    <button class="btn" onclick="exportToJSON()">ðŸ’¾ Export to JSON</button>
</div>

<script>
const API_URL = '/api/offices';
const categoryOptions = {
    pantry: ["Plates & Cutlery","Water Bottles","Cups & Glasses","Food Leftovers","Cleaners"],
    restrooms: ["Tissue Papers","Toilet Rolls","Sanitary Waste","Water Saving Devices","Cleaners"],
    meetingRooms: ["Cups & Glasses","Water Bottles","Printouts & Stationery","Plates & Cutlery","Cleaners"],
    events: ["Venue & Stage Decorations","Water Bottles","Displays & Badges","Food Waste","Plates & Cutlery"],
    premises: ["E-Waste","Garden Matter","Gray Water","Storm Water","Food Leftovers"]
};
const statusOptions = ["Not Started","Implemented"];

function openModal(){
    document.getElementById('officeModal').style.display = 'block';
    for (let cat in categoryOptions) {
        document.getElementById(cat + 'Inputs').innerHTML = createGroupedDropdowns(cat, {}, true);
    }
    // prefill dropdowns to "Not Started"
    document.querySelectorAll('#officeForm select').forEach(sel => sel.value = "Not Started");
}

function closeModal(){
    document.getElementById('officeModal').style.display = 'none';
    document.getElementById('officeForm').reset();
    document.querySelectorAll('#officeForm select').forEach(sel => sel.value = "Not Started");
}

async function saveNewOffice() {
    const form = document.getElementById('officeForm');
    const formData = collectFormData(form);
    await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
    closeModal();
    loadOffices();
}

/* Dropdown generator */
function createGroupedDropdowns(categoryName, data = {}, useName = false) {
    let html = "";
    for (let sub of categoryOptions[categoryName]) {
        let selectedStatus = data[sub] || "Not Started"; // default here
        html += `<div class="subcategory">
                    <label>${sub}</label>
                    <select ${useName ? `name="${categoryName}_${sub}"` : ""}>
                        ${statusOptions.map(s => `<option value="${s}" ${selectedStatus === s ? "selected" : ""}>${s}</option>`).join("")}
                    </select>
                 </div>`;
    }
    return html;
}

function renderGroupedDisplay(statusMap) {
    const total = 5;
    const implementedCount = Object.values(statusMap || {}).filter(s => s === "Implemented").length;
    const percent = (implementedCount / total) * 100;

    let color;
    if (percent <= 20) color = '#dc3545'; // red
    else if (percent <= 60) color = '#ffc107'; // yellow/orange
    else color = '#28a745'; // green

    return `
        <div class="bar-container">
            <div class="bar-fill" style="width: ${percent}%; background-color: ${color};"></div>
            <span class="bar-text">${implementedCount} / ${total}</span>
        </div>
    `;
}

/* Update Stats Visualization */
function updateStats(offices) {
    const totalOffices = offices.length;
    let fullyImplementedCount = 0;
    let totalImplemented = 0;
    const totalStatuses = totalOffices * 25; // 25 sub-categories per office

    offices.forEach(o => {
        const allStatuses = [
            ...Object.values(o.pantryStatus || {}),
            ...Object.values(o.restroomsStatus || {}),
            ...Object.values(o.meetingRoomsStatus || {}),
            ...Object.values(o.eventsStatus || {}),
            ...Object.values(o.premisesStatus || {})
        ];
        const implementedCount = allStatuses.filter(s => s === "Implemented").length;
        totalImplemented += implementedCount;
        if (implementedCount === 25) {
            fullyImplementedCount++;
        }
    });

    document.getElementById("totalOffices").innerText = totalOffices;
    document.getElementById("fullyImplemented").innerText = fullyImplementedCount;
    document.getElementById("inProgress").innerText = totalOffices - fullyImplementedCount;
    document.getElementById("averageProgress").innerText =
        totalStatuses > 0 ? Math.round((totalImplemented / totalStatuses) * 100) + "%" : "0%";
}

async function loadOffices() {
    const res = await fetch(API_URL);
    const offices = await res.json();

    // Update stats here
    updateStats(offices);

    const tbody = document.querySelector('#officeTable tbody');
    tbody.innerHTML = '';

    offices.forEach(o => {
        const getCompletionPercent = (office) => {
            let totalImplemented = 0;
            const categories = [
                office.pantryStatus,
                office.restroomsStatus,
                office.meetingRoomsStatus,
                office.eventsStatus,
                office.premisesStatus
            ];
            categories.forEach(cat => {
                totalImplemented += Object.values(cat || {}).filter(s => s === "Implemented").length;
            });
            const percent = ((totalImplemented / 25) * 100).toFixed(0);
            return `${percent}%`;
        };

        const completionPercent = getCompletionPercent(o);

        const row = document.createElement('tr');
        row.dataset.id = o._id;
        row.dataset.pantry = JSON.stringify(o.pantryStatus || {});
        row.dataset.restrooms = JSON.stringify(o.restroomsStatus || {});
        row.dataset.meetingRooms = JSON.stringify(o.meetingRoomsStatus || {});
        row.dataset.events = JSON.stringify(o.eventsStatus || {});
        row.dataset.premises = JSON.stringify(o.premisesStatus || {});

        row.innerHTML = `
            <td>${o.officeName || ''}</td>
            <td>${o.department || ''}</td>
            <td>${o.contactPerson || ''}</td>
            <td>${o.contactEmail || ''}</td>
            <td>${o.totalEmployees || ''}</td>
            <td>${renderGroupedDisplay(o.pantryStatus)}</td>
            <td>${renderGroupedDisplay(o.restroomsStatus)}</td>
            <td>${renderGroupedDisplay(o.meetingRoomsStatus)}</td>
            <td>${renderGroupedDisplay(o.eventsStatus)}</td>
            <td>${renderGroupedDisplay(o.premisesStatus)}</td>
            <td>${o.certificateDate || ''}</td>
            <td>${o.certificationStatus || 'Not Certified'}</td>
            <td class="completion-cell">${completionPercent}</td>
            <td>
                <button class="btn" onclick="editRow(this)">Edit</button>
                <button class="btn-danger" onclick="deleteOffice('${o._id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

/* Collect form data */
function collectFormData(container) {
    const formData = {};
    for (let cat in categoryOptions) {
        formData[cat + "Status"] = {};
    }

    container.querySelectorAll('input, select').forEach(el => {
        if (el.name.includes("_")) {
            const [cat, sub] = el.name.split("_");
            formData[cat + "Status"][sub] = el.value || "Not Started";
        } else {
            formData[el.name] = el.value;
        }
    });

    return formData;
}

/* Edit row */
function editRow(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');

    // Get existing statuses for prefill
    const id = row.dataset.id;
    fetch(`${API_URL}/${id}`)
        .then(res => res.json())
        .then(office => {
            cells[0].innerHTML = `<input name="officeName" value="${office.officeName || ''}">`;
            cells[1].innerHTML = `<input name="department" value="${office.department || ''}">`;
            cells[2].innerHTML = `<input name="contactPerson" value="${office.contactPerson || ''}">`;
            cells[3].innerHTML = `<input name="contactEmail" value="${office.contactEmail || ''}">`;
            cells[4].innerHTML = `<input name="totalEmployees" type="number" value="${office.totalEmployees || ''}">`;

            cells[5].innerHTML = createGroupedDropdowns("pantry", office.pantryStatus || {}, true);
            cells[6].innerHTML = createGroupedDropdowns("restrooms", office.restroomsStatus || {}, true);
            cells[7].innerHTML = createGroupedDropdowns("meetingRooms", office.meetingRoomsStatus || {}, true);
            cells[8].innerHTML = createGroupedDropdowns("events", office.eventsStatus || {}, true);
            cells[9].innerHTML = createGroupedDropdowns("premises", office.premisesStatus || {}, true);

            // Prefill "Not Started" for any empty dropdown
            row.querySelectorAll('select').forEach(sel => {
                if (!sel.value) sel.value = "Not Started";
            });

            cells[10].innerHTML = `<input name="certificateDate" type="date" value="${office.certificateDate || ''}">`;

            button.textContent = 'Save';
            button.className = 'btn-save';
            button.onclick = () => saveRow(row);
        });
}


/* Save new office */
async function saveNewOffice() {
    const form = document.getElementById('officeForm');
    const formData = collectFormData(form);
    await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
    closeModal(); loadOffices();
}

/* Save edited row */
async function saveRow(row) {
    const id = row.dataset.id;
    const formData = collectFormData(row);
    await fetch(`${API_URL}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    });
    loadOffices();
}


/* Delete */
async function deleteOffice(id) {
    if (confirm('Are you sure you want to delete this office?')) {
        await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        loadOffices();
    }
}

/* Export */
function exportToCSV() {
    fetch(API_URL).then(res => res.json()).then(data => {
        const headers = ["Office Name","Department","Contact Person","Contact Email","Total Employees"];
        Object.keys(categoryOptions).forEach(cat => 
            categoryOptions[cat].forEach(sub => headers.push(`${cat}_${sub}`))
        );
        headers.push("Certificate Date","Completion (%)","Certification Status");  // âœ… updated
        const csvRows = [headers.join(',')];

        data.forEach(o => {
            let row = [
                o.officeName||'', 
                o.department||'', 
                o.contactPerson||'', 
                o.contactEmail||'', 
                o.totalEmployees||''
            ];
            Object.keys(categoryOptions).forEach(cat => 
                categoryOptions[cat].forEach(sub => 
                    row.push((o[cat+"Status"] && o[cat+"Status"][sub]) || '')
                )
            );
            row.push(
                o.certificateDate||'', 
                o.completionPercent||'',       
                o.certificationStatus||''       
            );
            csvRows.push(row.map(v => `"${v}"`).join(','));
        });

        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = 'offices.csv'; 
        a.click();
    });
}

function exportToJSON() {
    fetch(API_URL).then(res => res.json()).then(data => {
        const cleaned = data.map(o => ({
            officeName: o.officeName || '',
            department: o.department || '',
            contactPerson: o.contactPerson || '',
            contactEmail: o.contactEmail || '',
            totalEmployees: o.totalEmployees || '',
            pantryStatus: o.pantryStatus || {},
            restroomsStatus: o.restroomsStatus || {},
            meetingRoomsStatus: o.meetingRoomsStatus || {},
            eventsStatus: o.eventsStatus || {},
            premisesStatus: o.premisesStatus || {},
            certificateDate: o.certificateDate || '',
            completionPercent: o.completionPercent || '',   
            certificationStatus: o.certificationStatus || '' 
        }));

        const blob = new Blob([JSON.stringify(cleaned, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = 'offices.json'; 
        a.click();
    });
}

window.onload = loadOffices;
</script>
</body>
</html>
