<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸŒ± Zero Waste Office Tracker</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h1 { text-align: center; }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        table-layout: fixed; /* ensures equal column sizing */
    }

    th, td {
        padding: 8px;
        border: 1px solid #ccc;
        text-align: center;
        vertical-align: top;
        word-wrap: break-word; /* ensures long text wraps */
    }

    /* Force equal widths for the 5 category columns */
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7),
    th:nth-child(8), td:nth-child(8),
    th:nth-child(9), td:nth-child(9),
    th:nth-child(10), td:nth-child(10) {
        width: 100px; /* adjust percentage so 5 of them fit evenly */
    }
    th { background: #28a745; color: white; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    .btn { background: #007bff; color: white; border: none; }
    .btn-danger { background: #dc3545; color: white; border: none; }
    .btn-save { background: #28a745; color: white; border: none; }
    select, input { width: 100%; }
    .export-section { margin-top: 20px; }
    .subcategory { margin-bottom: 5px; }
    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
             background-color: rgba(0,0,0,0.4); }
    .modal-content { background: #fff; margin: 5% auto; padding: 20px; width: 80%; border-radius: 8px; }
    .close { float: right; font-size: 28px; cursor: pointer; }
    .completion-cell {
        font-size: 1.2em; 
        font-weight: bold; 
    }
    .bar-container {
        position: relative;
        background-color: #f0f0f0;
        height: 20px;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        align-items: center;
    }

    .bar-fill {
        height: 100%;
        transition: width 0.4s ease;
    }

    .bar-text {
        position: absolute;
        width: 100%;
        text-align: center;
        font-size: 12px;
        font-weight: bold;
        color: #000;
    }
</style>
</head>
<body>

<h1>ðŸŒ± Zero Waste Office Tracker</h1>

<!-- Stats Visualization -->
<div id="statsContainer" style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
  <div style="flex:1; text-align:center; background:#f8f9fa; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <div id="totalOffices" style="font-size:2em; color:green;">0</div>
    <div>Total Offices</div>
  </div>
  <div style="flex:1; text-align:center; background:#f8f9fa; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <div id="fullyImplemented" style="font-size:2em; color:green;">0</div>
    <div>Fully Implemented</div>
  </div>
  <div style="flex:1; text-align:center; background:#f8f9fa; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <div id="inProgress" style="font-size:2em; color:green;">0</div>
    <div>In Progress</div>
  </div>
  <div style="flex:1; text-align:center; background:#f8f9fa; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <div id="averageProgress" style="font-size:2em; color:green;">0%</div>
    <div>Average Progress</div>
  </div>
</div>

<button class="btn" onclick="openModal()">âž• Add New Office</button>

<div id="officeModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Add New Office</h2>
    <form id="officeForm">
      <label>Office Name</label><input type="text" name="officeName">
      <label>Department</label><input type="text" name="department">
      <label>Contact Person</label><input type="text" name="contactPerson">
      <label>Contact Email</label><input type="text" name="contactEmail">
      <label>Total Employees</label><input type="number" name="totalEmployees">
      <h3>Pantry</h3><div id="pantryInputs"></div>
      <h3>Restrooms</h3><div id="restroomsInputs"></div>
      <h3>Meeting Rooms</h3><div id="meetingRoomsInputs"></div>
      <h3>Events</h3><div id="eventsInputs"></div>
      <h3>Premises</h3><div id="premisesInputs"></div>
      <label>Certificate Date</label><input type="date" name="certificateDate">
      <label>Notes</label><input type="text" name="notes">
      <br><br>
      <button type="button" class="btn-save" onclick="saveNewOffice()">Save Office</button>
    </form>
  </div>
</div>

<table id="officeTable">
<thead>
<tr>
    <th>Office Name</th><th>Department</th><th>Contact Person</th><th>Contact Email</th><th>Total Employees</th>
    <th>Pantry</th><th>Restrooms</th><th>Meeting Rooms</th><th>Events</th><th>Premises</th>
    <th>Certificate Date</th><th>Certification Status</th><th>Completion (%)</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="export-section">
    <button class="btn" onclick="exportToCSV()">ðŸ“Š Export to CSV</button>
    <button class="btn" onclick="exportToJSON()">ðŸ’¾ Export to JSON</button>
</div>

<script>
const API_URL = '/api/offices';
const categoryOptions = {
    pantry: ["Plates & Cutlery","Water Bottles","Cups & Glasses","Food Leftovers","Cleaners"],
    restrooms: ["Tissue Papers","Toilet Rolls","Sanitary Waste","Water Saving Devices","Cleaners"],
    meetingRooms: ["Cups & Glasses","Water Bottles","Printouts & Stationery","Plates & Cutlery","Cleaners"],
    events: ["Venue & Stage Decorations","Water Bottles","Displays & Badges","Food Waste","Plates & Cutlery"],
    premises: ["E-Waste","Garden Matter","Gray Water","Storm Water","Food Leftovers"]
};
const statusOptions = ["Not Started","Implemented"];

function openModal(){
    document.getElementById('officeModal').style.display = 'block';
    for (let cat in categoryOptions) {
        document.getElementById(cat + 'Inputs').innerHTML = createGroupedDropdowns(cat, {}, true);
    }
    // prefill dropdowns to "Not Started"
    document.querySelectorAll('#officeForm select').forEach(sel => sel.value = "Not Started");
}

function closeModal(){
    document.getElementById('officeModal').style.display = 'none';
    document.getElementById('officeForm').reset();
    document.querySelectorAll('#officeForm select').forEach(sel => sel.value = "Not Started");
}

async function saveNewOffice() {
    const form = document.getElementById('officeForm');
    const formData = collectFormData(form);
    await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
    closeModal();
    loadOffices();
}

/* Dropdown generator */
function createGroupedDropdowns(categoryName, data = {}, useName = false) {
    let html = "";
    for (let sub of categoryOptions[categoryName]) {
        let selectedStatus = data[sub] || "Not Started"; // default here
        html += `<div class="subcategory">
                    <label>${sub}</label>
                    <select ${useName ? `name="${categoryName}_${sub}"` : ""}>
                        ${statusOptions.map(s => `<option value="${s}" ${selectedStatus === s ? "selected" : ""}>${s}</option>`).join("")}
                    </select>
                 </div>`;
    }
    return html;
}

function renderGroupedDisplay(obj) {
    if (!obj) return "";
    let implementedCount = 0;
    let html = Object.entries(obj).map(([sub, status]) => {
        if (status === "Implemented") implementedCount++;
        return `<div style="border-bottom: 1px solid #ddd; padding: 2px 0;">
                    <b>${sub}:</b> ${status}
                </div>`;
    }).join("");

    html += `<div style="border-top: 2px solid #aaa; margin-top: 5px; padding-top: 3px;">
                <b>Score:</b> ${implementedCount}/25
             </div>`;
    return html;
}

/* Update Stats Visualization */
function updateStats(offices) {
    const totalOffices = offices.length;
    let fullyImplementedCount = 0;
    let totalImplemented = 0;
    const totalStatuses = totalOffices * 25; // 25 sub-categories per office

    offices.forEach(o => {
        const allStatuses = [
            ...Object.values(o.pantryStatus || {}),
            ...Object.values(o.restroomsStatus || {}),
            ...Object.values(o.meetingRoomsStatus || {}),
            ...Object.values(o.eventsStatus || {}),
            ...Object.values(o.premisesStatus || {})
        ];
        const implementedCount = allStatuses.filter(s => s === "Implemented").length;
        totalImplemented += implementedCount;
        if (implementedCount === 25) {
            fullyImplementedCount++;
        }
    });

    document.getElementById("totalOffices").innerText = totalOffices;
    document.getElementById("fullyImplemented").innerText = fullyImplementedCount;
    document.getElementById("inProgress").innerText = totalOffices - fullyImplementedCount;
    document.getElementById("averageProgress").innerText =
        totalStatuses > 0 ? Math.round((totalImplemented / totalStatuses) * 100) + "%" : "0%";
}

function getCertificationStatus(percent) {
    let num = parseInt(percent.replace("%", "")) || 0;
    let status = "Not Certified";
    let color = "black";

    if (num >= 90) { status = "Platinum"; color = "darkslategray"; }
    else if (num >= 80) { status = "Gold"; color = "gold"; }
    else if (num >= 70) { status = "Silver"; color = "silver"; }
    else if (num >= 60) { status = "Bronze"; color = "saddlebrown"; }
    else if (num >= 50) { status = "Certified"; color = "gray"; }

    return `<span style="color:${color}; font-weight:bold;">${status}</span>`;
}


/* Modify loadOffices to also refresh stats */
async function loadOffices() {
    const res = await fetch(API_URL);
    const offices = await res.json();

    // Update stats here
    updateStats(offices);

    const tbody = document.querySelector('#officeTable tbody');
    tbody.innerHTML = '';

    offices.forEach(o => {
        const getCategoryScore = (statusMap) => {
            const implementedCount = Object.values(statusMap || {}).filter(s => s === "Implemented").length;
            const percentage = (implementedCount / 5) * 100;

            let color = "#ff4d4d"; // red
            if (percentage >= 75) color = "#4CAF50"; // green
            else if (percentage >= 50) color = "#FFB300"; // orange
            else if (percentage >= 25) color = "#FF7043"; // light orange

            return `
                <div class="bar-container">
                    <div class="bar-fill" style="width: ${percentage}%; background-color: ${color};"></div>
                    <span class="bar-text">${implementedCount} / 5</span>
                </div>
            `;
        };

        const getCompletionPercent = (office) => {
            let totalImplemented = 0;
            const categories = [
                office.pantryStatus,
                office.restroomsStatus,
                office.meetingRoomsStatus,
                office.eventsStatus,
                office.premisesStatus
            ];
            categories.forEach(cat => {
                totalImplemented += Object.values(cat || {}).filter(s => s === "Implemented").length;
            });
            const percent = ((totalImplemented / 25) * 100).toFixed(0);
            return `${percent}%`;
        };

        const completionPercent = getCompletionPercent(o);

        const row = document.createElement('tr');
        row.dataset.id = o._id;
        row.dataset.pantry = JSON.stringify(o.pantryStatus || {});
        row.dataset.restrooms = JSON.stringify(o.restroomsStatus || {});
        row.dataset.meetingRooms = JSON.stringify(o.meetingRoomsStatus || {});
        row.dataset.events = JSON.stringify(o.eventsStatus || {});
        row.dataset.premises = JSON.stringify(o.premisesStatus || {});

        row.innerHTML = `
            <td>${o.officeName || ''}</td>
            <td>${o.department || ''}</td>
            <td>${o.contactPerson || ''}</td>
            <td>${o.contactEmail || ''}</td>
            <td>${o.totalEmployees || ''}</td>
            <td>${getCategoryScore(o.pantryStatus)}</td>
            <td>${getCategoryScore(o.restroomsStatus)}</td>
            <td>${getCategoryScore(o.meetingRoomsStatus)}</td>
            <td>${getCategoryScore(o.eventsStatus)}</td>
            <td>${getCategoryScore(o.premisesStatus)}</td>
            <td>${o.certificateDate || ''}</td> <!-- Restored -->
            <td class="completion-cell">${completionPercent}</td>
            <td>${getCertificationStatus(completionPercent)}</td>
            <td>
                <button class="btn" onclick="editRow(this)">Edit</button>
                <button class="btn-danger" onclick="deleteOffice('${o._id}')">Delete</button>
            </td>
        `;

        tbody.appendChild(row);
    });
}

/* Collect form data */
function collectFormData(container) {
    const formData = {};
    for (let cat in categoryOptions) {
        formData[cat + "Status"] = {};
    }

    container.querySelectorAll('input, select').forEach(el => {
        if (el.name.includes("_")) {
            const [cat, sub] = el.name.split("_");
            formData[cat + "Status"][sub] = el.value || "Not Started";
        } else {
            formData[el.name] = el.value;
        }
    });

    return formData;
}

/* Edit row */
function editRow(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');

    // Get existing statuses for prefill
    const id = row.dataset.id;
    fetch(`${API_URL}/${id}`)
        .then(res => res.json())
        .then(office => {
            cells[0].innerHTML = `<input name="officeName" value="${office.officeName || ''}">`;
            cells[1].innerHTML = `<input name="department" value="${office.department || ''}">`;
            cells[2].innerHTML = `<input name="contactPerson" value="${office.contactPerson || ''}">`;
            cells[3].innerHTML = `<input name="contactEmail" value="${office.contactEmail || ''}">`;
            cells[4].innerHTML = `<input name="totalEmployees" type="number" value="${office.totalEmployees || ''}">`;

            cells[5].innerHTML = createGroupedDropdowns("pantry", office.pantryStatus || {}, true);
            cells[6].innerHTML = createGroupedDropdowns("restrooms", office.restroomsStatus || {}, true);
            cells[7].innerHTML = createGroupedDropdowns("meetingRooms", office.meetingRoomsStatus || {}, true);
            cells[8].innerHTML = createGroupedDropdowns("events", office.eventsStatus || {}, true);
            cells[9].innerHTML = createGroupedDropdowns("premises", office.premisesStatus || {}, true);

            // Prefill "Not Started" for any empty dropdown
            row.querySelectorAll('select').forEach(sel => {
                if (!sel.value) sel.value = "Not Started";
            });

            cells[10].innerHTML = `<input name="certificateDate" type="date" value="${office.certificateDate || ''}">`;
            cells[11].innerHTML = `<input name="notes" value="${office.notes || ''}">`;

            button.textContent = 'Save';
            button.className = 'btn-save';
            button.onclick = () => saveRow(row);
        });
}


/* Save new office */
async function saveNewOffice() {
    const form = document.getElementById('officeForm');
    const formData = collectFormData(form);
    await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
    closeModal(); loadOffices();
}

/* Save edited row */
async function saveRow(row) {
    const id = row.dataset.id;
    const formData = collectFormData(row);
    await fetch(`${API_URL}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    });
    loadOffices();
}


/* Delete */
async function deleteOffice(id) {
    if (confirm('Are you sure you want to delete this office?')) {
        await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        loadOffices();
    }
}

/* Export */
function exportToCSV() {
    fetch(API_URL).then(res => res.json()).then(data => {
        const headers = ["Office Name","Department","Contact Person","Contact Email","Total Employees"];
        Object.keys(categoryOptions).forEach(cat => categoryOptions[cat].forEach(sub => headers.push(`${cat}_${sub}`)));
        headers.push("Certificate Date","Notes");
        const csvRows = [headers.join(',')];
        data.forEach(o => {
            let row = [o.officeName||'', o.department||'', o.contactPerson||'', o.contactEmail||'', o.totalEmployees||''];
            Object.keys(categoryOptions).forEach(cat => categoryOptions[cat].forEach(sub => row.push((o[cat+"Status"] && o[cat+"Status"][sub]) || '')));
            row.push(o.certificateDate||'', o.notes||'');
            csvRows.push(row.map(v => `"${v}"`).join(','));
        });
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'offices.csv'; a.click();
    });
}
function exportToJSON() {
    fetch(API_URL).then(res => res.json()).then(data => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'offices.json'; a.click();
    });
}

window.onload = loadOffices;
</script>
</body>
</html>
