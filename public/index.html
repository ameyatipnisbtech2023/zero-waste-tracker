<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üå± Zero Waste Office Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #2e7d32; }
        .controls, .stats-grid, .export-section { margin: 20px 0; }
        .controls select, .controls input { padding: 5px; margin: 5px; }
        .btn { background: #2e7d32; color: white; padding: 8px 12px; border: none; cursor: pointer; }
        .btn:hover { background: #1b5e20; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #388e3c; color: white; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üå± Zero Waste Office Tracker</h1>
        <button class="btn" onclick="openModal()">‚ûï Add New Office</button>
    </div>

    <!-- Filters -->
    <div class="controls">
        <label>Area:</label>
        <select id="areaFilter">
            <option value="">All</option>
            <option value="Pantry">Pantry</option>
            <option value="Restrooms">Restrooms</option>
            <option value="Meeting Rooms">Meeting Rooms</option>
            <option value="Events">Events</option>
            <option value="Premises">Premises</option>
        </select>
        <label>Status:</label>
        <select id="statusFilter">
            <option value="">All</option>
            <option value="Implemented">Implemented</option>
            <option value="Planned">Planned</option>
            <option value="Not Started">Not Started</option>
        </select>
        <button class="btn" onclick="loadOffices()">Apply Filters</button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card"><div id="totalOffices">0</div><div>Total Offices</div></div>
        <div class="stat-card"><div id="implementedCount">0</div><div>Implemented</div></div>
        <div class="stat-card"><div id="plannedCount">0</div><div>Planned</div></div>
        <div class="stat-card"><div id="notStartedCount">0</div><div>Not Started</div></div>
    </div>

    <!-- Offices Table -->
    <table>
        <thead>
            <tr>
                <th>Office Name</th>
                <th>Department</th>
                <th>Contact Person</th>
                <th>Pantry</th>
                <th>Restrooms</th>
                <th>Meeting Rooms</th>
                <th>Events</th>
                <th>Premises</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="officeTableBody"></tbody>
    </table>

    <!-- Export -->
    <div class="export-section">
        <h3>Export Data</h3>
        <button class="btn" onclick="exportToCSV()">üìä Export CSV</button>
        <button class="btn" onclick="exportToJSON()">üíæ Export JSON</button>
    </div>
</div>

<!-- Modal -->
<div id="officeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0005;">
    <div style="background:white; padding:20px; width:400px; margin:100px auto;">
        <h3 id="modalTitle">Add Office</h3>
        <form id="officeForm">
            <input type="hidden" id="officeId">
            <input placeholder="Office Name" id="officeName" required><br>
            <input placeholder="Department" id="department"><br>
            <input placeholder="Contact Person" id="contactPerson" required><br>
            <select id="pantryStatus">
                <option value="Not Started">Not Started</option>
                <option value="Planned">Planned</option>
                <option value="Implemented">Implemented</option>
            </select>
            <select id="restroomsStatus">
                <option value="Not Started">Not Started</option>
                <option value="Planned">Planned</option>
                <option value="Implemented">Implemented</option>
            </select><br>
            <button class="btn" type="submit">Save</button>
            <button type="button" class="btn" onclick="closeModal()">Cancel</button>
        </form>
    </div>
</div>

<script>
const API_URL = '/api/offices';

// Load Offices
async function loadOffices() {
    let res = await fetch(API_URL);
    let data = await res.json();

    const areaFilter = document.getElementById('areaFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;

    if (areaFilter) {
        data = data.filter(o => o[`${areaFilter.toLowerCase()}Status`] === statusFilter || !statusFilter);
    } else if (statusFilter) {
        data = data.filter(o =>
            o.pantryStatus === statusFilter ||
            o.restroomsStatus === statusFilter ||
            o.meetingRoomsStatus === statusFilter ||
            o.eventsStatus === statusFilter ||
            o.premisesStatus === statusFilter
        );
    }

    document.getElementById('officeTableBody').innerHTML = data.map(o => `
        <tr>
            <td>${o.officeName}</td>
            <td>${o.department || ''}</td>
            <td>${o.contactPerson}</td>
            <td>${o.pantryStatus}</td>
            <td>${o.restroomsStatus}</td>
            <td>${o.meetingRoomsStatus}</td>
            <td>${o.eventsStatus}</td>
            <td>${o.premisesStatus}</td>
            <td>
                <button onclick="editOffice('${o._id}')">‚úè Edit</button>
                <button onclick="deleteOffice('${o._id}')">üóë Delete</button>
            </td>
        </tr>
    `).join('');

    // Stats
    document.getElementById('totalOffices').innerText = data.length;
    document.getElementById('implementedCount').innerText = data.filter(o => o.pantryStatus === 'Implemented').length;
    document.getElementById('plannedCount').innerText = data.filter(o => o.pantryStatus === 'Planned').length;
    document.getElementById('notStartedCount').innerText = data.filter(o => o.pantryStatus === 'Not Started').length;
}

// Add/Edit Office
document.getElementById('officeForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('officeId').value;
    const office = {
        officeName: document.getElementById('officeName').value,
        department: document.getElementById('department').value,
        contactPerson: document.getElementById('contactPerson').value,
        pantryStatus: document.getElementById('pantryStatus').value,
        restroomsStatus: document.getElementById('restroomsStatus').value
    };

    if (id) {
        await fetch(`${API_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(office) });
    } else {
        await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(office) });
    }
    closeModal();
    loadOffices();
});

// Edit
async function editOffice(id) {
    const res = await fetch(`${API_URL}/${id}`);
    const o = await res.json();
    document.getElementById('officeId').value = o._id;
    document.getElementById('officeName').value = o.officeName;
    document.getElementById('department').value = o.department || '';
    document.getElementById('contactPerson').value = o.contactPerson;
    document.getElementById('pantryStatus').value = o.pantryStatus;
    document.getElementById('restroomsStatus').value = o.restroomsStatus;
    openModal();
}

// Delete
async function deleteOffice(id) {
    if (confirm('Delete this office?')) {
        await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        loadOffices();
    }
}

// Export
async function exportToCSV() {
    const res = await fetch(API_URL);
    const data = await res.json();
    const csv = [Object.keys(data[0]).join(','), ...data.map(row => Object.values(row).join(','))].join('\n');
    downloadFile(csv, 'offices.csv', 'text/csv');
}

async function exportToJSON() {
    const res = await fetch(API_URL);
    const data = await res.json();
    downloadFile(JSON.stringify(data, null, 2), 'offices.json', 'application/json');
}

function downloadFile(content, fileName, type) {
    const a = document.createElement('a');
    const file = new Blob([content], { type });
    a.href = URL.createObjectURL(file);
    a.download = fileName;
    a.click();
}

// Modal
function openModal() { document.getElementById('officeModal').style.display = 'block'; }
function closeModal() { document.getElementById('officeModal').style.display = 'none'; document.getElementById('officeForm').reset(); document.getElementById('officeId').value = ''; }

window.onload = loadOffices;
</script>
</body>
</html>
