<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zero Waste Office Tracker</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #4CAF50; color: white; }
    input, select, textarea, button { padding: 5px; }
    .btn { padding: 5px 10px; margin: 2px; cursor: pointer; }
    .export-section { margin-top: 20px; }
</style>
</head>
<body>
<div class="container">
    <h1>ðŸŒ± Zero Waste Office Tracker</h1>

    <!-- Add Office Form -->
    <form id="officeForm">
        <input name="officeName" placeholder="Office Name" required>
        <input name="department" placeholder="Department">
        <input name="contactPerson" placeholder="Contact Person" required>
        <input name="contactEmail" type="email" placeholder="Contact Email">
        <input name="totalEmployees" type="number" placeholder="Total Employees" min="1">
        <select name="pantryStatus">
            <option value="Not Started">Not Started</option>
            <option value="Planned">Planned</option>
            <option value="Implemented">Implemented</option>
        </select>
        <select name="restroomsStatus">
            <option value="Not Started">Not Started</option>
            <option value="Planned">Planned</option>
            <option value="Implemented">Implemented</option>
        </select>
        <select name="meetingRoomsStatus">
            <option value="Not Started">Not Started</option>
            <option value="Planned">Planned</option>
            <option value="Implemented">Implemented</option>
        </select>
        <select name="eventsStatus">
            <option value="Not Started">Not Started</option>
            <option value="Planned">Planned</option>
            <option value="Implemented">Implemented</option>
        </select>
        <select name="premisesStatus">
            <option value="Not Started">Not Started</option>
            <option value="Planned">Planned</option>
            <option value="Implemented">Implemented</option>
        </select>
        <input name="certificateDate" type="date">
        <textarea name="notes" placeholder="Notes"></textarea>
        <button type="submit">Add New Office</button>
    </form>

    <!-- Office Table -->
    <table id="officeTable">
        <thead>
            <tr>
                <th>Office Name</th>
                <th>Department</th>
                <th>Contact Person</th>
                <th>Contact Email</th>
                <th>Total Employees</th>
                <th>Pantry</th>
                <th>Restrooms</th>
                <th>Meeting Rooms</th>
                <th>Events</th>
                <th>Premises</th>
                <th>Certificate Date</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Export Buttons -->
    <div class="export-section">
        <button onclick="exportCSV()">ðŸ“Š Export to CSV</button>
        <button onclick="exportJSON()">ðŸ’¾ Export to JSON</button>
    </div>
</div>

<script>
const API_URL = '/api/offices';
let offices = [];

async function loadOffices() {
    const res = await fetch(API_URL);
    offices = await res.json();
    renderTable();
}

function renderTable() {
    const tbody = document.querySelector('#officeTable tbody');
    tbody.innerHTML = '';
    offices.forEach(office => {
        const row = document.createElement('tr');
        row.innerHTML = `
            ${makeCell(office.officeName)}
            ${makeCell(office.department)}
            ${makeCell(office.contactPerson)}
            ${makeCell(office.contactEmail)}
            ${makeCell(office.totalEmployees)}
            ${makeCell(office.pantryStatus)}
            ${makeCell(office.restroomsStatus)}
            ${makeCell(office.meetingRoomsStatus)}
            ${makeCell(office.eventsStatus)}
            ${makeCell(office.premisesStatus)}
            ${makeCell(office.certificateDate)}
            ${makeCell(office.notes)}
            <td>
                <button onclick="editRow('${office._id}', this)">Edit</button>
                <button onclick="deleteOffice('${office._id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function makeCell(content) {
    return `<td>${content || ''}</td>`;
}

function editRow(id, btn) {
    const row = btn.closest('tr');
    const office = offices.find(o => o._id === id);
    row.innerHTML = `
        ${inputCell('officeName', office.officeName)}
        ${inputCell('department', office.department)}
        ${inputCell('contactPerson', office.contactPerson)}
        ${inputCell('contactEmail', office.contactEmail, 'email')}
        ${inputCell('totalEmployees', office.totalEmployees, 'number')}
        ${selectCell('pantryStatus', office.pantryStatus)}
        ${selectCell('restroomsStatus', office.restroomsStatus)}
        ${selectCell('meetingRoomsStatus', office.meetingRoomsStatus)}
        ${selectCell('eventsStatus', office.eventsStatus)}
        ${selectCell('premisesStatus', office.premisesStatus)}
        ${inputCell('certificateDate', office.certificateDate, 'date')}
        ${textareaCell('notes', office.notes)}
        <td>
            <button onclick="saveRow('${id}', this)">Save</button>
            <button onclick="loadOffices()">Cancel</button>
        </td>
    `;
}

function inputCell(name, value, type = 'text') {
    return `<td><input name="${name}" type="${type}" value="${value || ''}"></td>`;
}

function textareaCell(name, value) {
    return `<td><textarea name="${name}">${value || ''}</textarea></td>`;
}

function selectCell(name, value) {
    const options = ['Not Started','Planned','Implemented'];
    return `<td><select name="${name}">${options.map(opt =>
        `<option value="${opt}" ${opt===value?'selected':''}>${opt}</option>`).join('')}</select></td>`;
}

async function saveRow(id, btn) {
    const row = btn.closest('tr');
    const data = {};
    row.querySelectorAll('input, select, textarea').forEach(el => data[el.name] = el.value);
    await fetch(`${API_URL}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    loadOffices();
}

async function deleteOffice(id) {
    if (confirm('Delete this office?')) {
        await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        loadOffices();
    }
}

document.querySelector('#officeForm').addEventListener('submit', async e => {
    e.preventDefault();
    const data = {};
    e.target.querySelectorAll('input, select, textarea').forEach(el => data[el.name] = el.value);
    await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    e.target.reset();
    loadOffices();
});

function exportCSV() {
    let csv = Object.keys(offices[0] || {}).filter(k => k !== '_id' && k !== '__v').join(',') + '\n';
    offices.forEach(o => {
        csv += Object.keys(o).filter(k => k !== '_id' && k !== '__v').map(k => `"${o[k]||''}"`).join(',') + '\n';
    });
    downloadFile(csv, 'offices.csv', 'text/csv');
}

function exportJSON() {
    downloadFile(JSON.stringify(offices, null, 2), 'offices.json', 'application/json');
}

function downloadFile(content, fileName, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName; a.click();
    URL.revokeObjectURL(url);
}

loadOffices();
</script>
</body>
</html>
