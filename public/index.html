<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸŒ± Zero Waste Office Tracker</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; vertical-align: top; }
    th { background: #28a745; color: white; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    .btn { background: #007bff; color: white; border: none; }
    .btn-danger { background: #dc3545; color: white; border: none; }
    .btn-save { background: #28a745; color: white; border: none; }
    select, input { width: 100%; }
    .subcategory { margin-bottom: 5px; }
    .export-section { margin-top: 20px; }
    /* Modal styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.5); }
    .modal-content { background: #fff; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-height: 90vh; overflow-y: auto; }
    .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
    .modal-close { float: right; font-size: 20px; cursor: pointer; }
</style>
</head>
<body>

<h1>ðŸŒ± Zero Waste Office Tracker</h1>

<button class="btn" onclick="openModal()">âž• Add New Office</button>

<table id="officeTable">
    <thead>
        <tr>
            <th>Office Name</th>
            <th>Department</th>
            <th>Contact Person</th>
            <th>Contact Email</th>
            <th>Total Employees</th>
            <th>Pantry</th>
            <th>Restrooms</th>
            <th>Meeting Rooms</th>
            <th>Events</th>
            <th>Premises</th>
            <th>Certificate Date</th>
            <th>Notes</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="export-section">
    <button class="btn" onclick="exportToCSV()">ðŸ“Š Export to CSV</button>
    <button class="btn" onclick="exportToJSON()">ðŸ’¾ Export to JSON</button>
</div>

<!-- Modal for Add New Office -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-header">âž• Add New Office</div>
        <div>
            <label>Office Name</label><input type="text" id="new_officeName">
            <label>Department</label><input type="text" id="new_department">
            <label>Contact Person</label><input type="text" id="new_contactPerson">
            <label>Contact Email</label><input type="text" id="new_contactEmail">
            <label>Total Employees</label><input type="number" id="new_totalEmployees">
            <h3>Pantry</h3>
            <div id="new_pantry"></div>
            <h3>Restrooms</h3>
            <div id="new_restrooms"></div>
            <h3>Meeting Rooms</h3>
            <div id="new_meetingRooms"></div>
            <h3>Events</h3>
            <div id="new_events"></div>
            <h3>Premises</h3>
            <div id="new_premises"></div>
            <label>Certificate Date</label><input type="date" id="new_certificateDate">
            <label>Notes</label><input type="text" id="new_notes">
        </div>
        <br>
        <button class="btn-save" onclick="saveNewOffice()">Save Office</button>
    </div>
</div>

<script>
const API_URL = '/api/offices';

const categoryOptions = {
    pantry: ["Plates & Cutlery","Water Bottles","Cups & Glasses","Food Leftovers","Cleaners"],
    restrooms: ["Tissue Papers","Toilet Rolls","Sanitary Waste","Water Saving Devices","Cleaners"],
    meetingRooms: ["Cups & Glasses","Water Bottles","Printouts & Stationery","Plates & Cutlery","Cleaners"],
    events: ["Venue & Stage Decorations","Water Bottles","Displays & Badges","Food Waste","Plates & Cutlery"],
    premises: ["E-Waste","Garden Matter","Gray Water","Storm Water","Food Leftovers"]
};

const statusOptions = ["Not Started","Planned","Implemented"];

function createGroupedDropdowns(categoryName, data = {}) {
    let html = "";
    for (let sub of categoryOptions[categoryName]) {
        let selectedStatus = data[sub] || "";
        html += `<div class="subcategory">
                    <label>${sub}</label>
                    <select>
                        <option value="">--Select Status--</option>
                        ${statusOptions.map(s => `<option value="${s}" ${selectedStatus === s ? "selected":""}>${s}</option>`).join("")}
                    </select>
                 </div>`;
    }
    return html;
}

async function loadOffices() {
    const res = await fetch(API_URL);
    const offices = await res.json();
    const tbody = document.querySelector('#officeTable tbody');
    tbody.innerHTML = '';
    offices.forEach(office => {
        const row = document.createElement('tr');
        row.dataset.id = office._id;
        row.innerHTML = `
            <td>${office.officeName || ''}</td>
            <td>${office.department || ''}</td>
            <td>${office.contactPerson || ''}</td>
            <td>${office.contactEmail || ''}</td>
            <td>${office.totalEmployees || ''}</td>
            <td>${renderGroupedDisplay(office.pantryStatus)}</td>
            <td>${renderGroupedDisplay(office.restroomsStatus)}</td>
            <td>${renderGroupedDisplay(office.meetingRoomsStatus)}</td>
            <td>${renderGroupedDisplay(office.eventsStatus)}</td>
            <td>${renderGroupedDisplay(office.premisesStatus)}</td>
            <td>${office.certificateDate || ''}</td>
            <td>${office.notes || ''}</td>
            <td>
                <button class="btn" onclick="editRow(this)">Edit</button>
                <button class="btn-danger" onclick="deleteOffice('${office._id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderGroupedDisplay(obj) {
    if (!obj) return "";
    return Object.entries(obj).map(([sub, status]) => `<div><b>${sub}:</b> ${status}</div>`).join("");
}

function editRow(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');
    cells[0].innerHTML = `<input type="text" value="${cells[0].innerText}">`;
    cells[1].innerHTML = `<input type="text" value="${cells[1].innerText}">`;
    cells[2].innerHTML = `<input type="text" value="${cells[2].innerText}">`;
    cells[3].innerHTML = `<input type="text" value="${cells[3].innerText}">`;
    cells[4].innerHTML = `<input type="number" value="${cells[4].innerText}">`;
    cells[5].innerHTML = createGroupedDropdowns("pantry");
    cells[6].innerHTML = createGroupedDropdowns("restrooms");
    cells[7].innerHTML = createGroupedDropdowns("meetingRooms");
    cells[8].innerHTML = createGroupedDropdowns("events");
    cells[9].innerHTML = createGroupedDropdowns("premises");
    cells[10].innerHTML = `<input type="date" value="${cells[10].innerText}">`;
    cells[11].innerHTML = `<input type="text" value="${cells[11].innerText}">`;
    button.textContent = 'Save';
    button.className = 'btn-save';
    button.onclick = () => saveRow(row);
}

async function saveRow(row) {
    const id = row.dataset.id;
    const inputs = row.querySelectorAll('input');
    const selects = row.querySelectorAll('td select');
    const updatedOffice = {
        officeName: inputs[0].value,
        department: inputs[1].value,
        contactPerson: inputs[2].value,
        contactEmail: inputs[3].value,
        totalEmployees: inputs[4].value,
        pantryStatus: getCategoryData(selects, "pantry"),
        restroomsStatus: getCategoryData(selects, "restrooms"),
        meetingRoomsStatus: getCategoryData(selects, "meetingRooms"),
        eventsStatus: getCategoryData(selects, "events"),
        premisesStatus: getCategoryData(selects, "premises"),
        certificateDate: inputs[5].value,
        notes: inputs[6].value
    };
    await fetch(`${API_URL}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedOffice)
    });
    loadOffices();
}

function getCategoryData(selects, categoryName) {
    const subs = categoryOptions[categoryName];
    let obj = {};
    subs.forEach((sub, i) => {
        obj[sub] = selects[i].value || "";
    });
    // Remove the processed selects from the NodeList for the next category
    for (let i = 0; i < subs.length; i++) {
        selects.shift();
    }
    return obj;
}


async function deleteOffice(id) {
    if (confirm('Are you sure?')) {
        await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        loadOffices();
    }
}

function openModal() {
    document.getElementById('addModal').style.display = 'block';
    document.getElementById('new_pantry').innerHTML = createGroupedDropdowns("pantry");
    document.getElementById('new_restrooms').innerHTML = createGroupedDropdowns("restrooms");
    document.getElementById('new_meetingRooms').innerHTML = createGroupedDropdowns("meetingRooms");
    document.getElementById('new_events').innerHTML = createGroupedDropdowns("events");
    document.getElementById('new_premises').innerHTML = createGroupedDropdowns("premises");
}

function closeModal() {
    document.getElementById('addModal').style.display = 'none';
}

async function saveNewOffice() {
    const selects = document.querySelectorAll('#addModal select');
    const newOffice = {
        officeName: document.getElementById('new_officeName').value,
        department: document.getElementById('new_department').value,
        contactPerson: document.getElementById('new_contactPerson').value,
        contactEmail: document.getElementById('new_contactEmail').value,
        totalEmployees: document.getElementById('new_totalEmployees').value,
        pantryStatus: getCategoryData(selects, "pantry"),
        restroomsStatus: getCategoryData(selects, "restrooms"),
        meetingRoomsStatus: getCategoryData(selects, "meetingRooms"),
        eventsStatus: getCategoryData(selects, "events"),
        premisesStatus: getCategoryData(selects, "premises"),
        certificateDate: document.getElementById('new_certificateDate').value,
        notes: document.getElementById('new_notes').value
    };
    await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newOffice)
    });
    closeModal();
    loadOffices();
}

function exportToCSV() {
    fetch(API_URL)
        .then(res => res.json())
        .then(data => {
            const headers = ["Office Name","Department","Contact Person","Contact Email","Total Employees"];
            Object.keys(categoryOptions).forEach(cat => {
                categoryOptions[cat].forEach(sub => headers.push(`${cat}_${sub}`));
            });
            headers.push("Certificate Date","Notes");

            const csvRows = [headers.join(',')];
            data.forEach(o => {
                let row = [
                    o.officeName || '',
                    o.department || '',
                    o.contactPerson || '',
                    o.contactEmail || '',
                    o.totalEmployees || ''
                ];
                Object.keys(categoryOptions).forEach(cat => {
                    categoryOptions[cat].forEach(sub => {
                        row.push((o[cat + "Status"] && o[cat + "Status"][sub]) || '');
                    });
                });
                row.push(o.certificateDate || '', o.notes || '');
                csvRows.push(row.map(v => `"${v}"`).join(','));
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'offices.csv';
            a.click();
        });
}

function exportToJSON() {
    fetch(API_URL)
        .then(res => res.json())
        .then(data => {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'offices.json';
            a.click();
        });
}

window.onload = loadOffices;
</script>
</body>
</html>
