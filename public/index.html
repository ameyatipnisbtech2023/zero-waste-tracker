<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŒ± Zero Waste Office Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f8f8; }
        h1 { color: #2e7d32; }
        table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #e0f2f1; }
        input, select, button { padding: 6px; margin: 5px; }
        .form-section { background: #fff; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .btn { background: #2e7d32; color: white; border: none; cursor: pointer; padding: 6px 12px; }
        .btn:hover { background: #1b5e20; }
        .export-section { margin-top: 20px; background: #fff; padding: 15px; border-radius: 6px; }
    </style>
</head>
<body>

    <h1>ðŸŒ± Zero Waste Office Tracker</h1>

    <div class="form-section">
        <h2>Add / Edit Office</h2>
        <form id="officeForm">
            <input type="hidden" id="officeId">
            <input type="text" id="officeName" placeholder="Office Name" required>
            <input type="text" id="department" placeholder="Department">
            <input type="text" id="contactPerson" placeholder="Contact Person">
            <input type="email" id="contactEmail" placeholder="Contact Email">
            <input type="number" id="totalEmployees" placeholder="Total Employees" min="1">

            <select id="pantryStatus">
                <option value="">Pantry Status</option>
                <option value="Not Started">Not Started</option>
                <option value="Planned">Planned</option>
                <option value="Implemented">Implemented</option>
            </select>
            <select id="restroomsStatus">
                <option value="">Restrooms Status</option>
                <option value="Not Started">Not Started</option>
                <option value="Planned">Planned</option>
                <option value="Implemented">Implemented</option>
            </select>
            <select id="meetingRoomsStatus">
                <option value="">Meeting Rooms Status</option>
                <option value="Not Started">Not Started</option>
                <option value="Planned">Planned</option>
                <option value="Implemented">Implemented</option>
            </select>
            <select id="eventsStatus">
                <option value="">Events Status</option>
                <option value="Not Started">Not Started</option>
                <option value="Planned">Planned</option>
                <option value="Implemented">Implemented</option>
            </select>
            <select id="premisesStatus">
                <option value="">Premises Status</option>
                <option value="Not Started">Not Started</option>
                <option value="Planned">Planned</option>
                <option value="Implemented">Implemented</option>
            </select>

            <input type="date" id="certificateDate">
            <button type="submit" class="btn">Save Office</button>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>Office Name</th>
                <th>Department</th>
                <th>Contact Person</th>
                <th>Contact Email</th>
                <th>Total Employees</th>
                <th>Pantry</th>
                <th>Restrooms</th>
                <th>Meeting Rooms</th>
                <th>Events</th>
                <th>Premises</th>
                <th>Certificate Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="officeTableBody"></tbody>
    </table>

    <div class="export-section">
        <h3>ðŸ“‚ Export Data</h3>
        <button class="btn" onclick="exportToCSV()">Export to CSV</button>
        <button class="btn" onclick="exportToJSON()">Export to JSON</button>
    </div>

    <script>
        const API_URL = '/api/offices';

        async function loadOffices() {
            const res = await fetch(API_URL);
            const offices = await res.json();
            const tbody = document.getElementById('officeTableBody');
            tbody.innerHTML = '';
            offices.forEach(office => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${office.officeName || ''}</td>
                    <td>${office.department || ''}</td>
                    <td>${office.contactPerson || ''}</td>
                    <td>${office.contactEmail || ''}</td>
                    <td>${office.totalEmployees || ''}</td>
                    <td>${office.pantryStatus || ''}</td>
                    <td>${office.restroomsStatus || ''}</td>
                    <td>${office.meetingRoomsStatus || ''}</td>
                    <td>${office.eventsStatus || ''}</td>
                    <td>${office.premisesStatus || ''}</td>
                    <td>${office.certificateDate || ''}</td>
                    <td>
                        <button onclick="editOffice('${office._id}')">Edit</button>
                        <button onclick="deleteOffice('${office._id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function saveOffice(e) {
            e.preventDefault();
            const office = {
                officeName: document.getElementById('officeName').value,
                department: document.getElementById('department').value,
                contactPerson: document.getElementById('contactPerson').value,
                contactEmail: document.getElementById('contactEmail').value,
                totalEmployees: document.getElementById('totalEmployees').value,
                pantryStatus: document.getElementById('pantryStatus').value,
                restroomsStatus: document.getElementById('restroomsStatus').value,
                meetingRoomsStatus: document.getElementById('meetingRoomsStatus').value,
                eventsStatus: document.getElementById('eventsStatus').value,
                premisesStatus: document.getElementById('premisesStatus').value,
                certificateDate: document.getElementById('certificateDate').value
            };
            const id = document.getElementById('officeId').value;

            if (id) {
                await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(office)
                });
            } else {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(office)
                });
            }
            document.getElementById('officeForm').reset();
            document.getElementById('officeId').value = '';
            loadOffices();
        }

        async function editOffice(id) {
            const res = await fetch(`${API_URL}`);
            const offices = await res.json();
            const office = offices.find(o => o._id === id);
            if (!office) return;

            document.getElementById('officeId').value = office._id;
            document.getElementById('officeName').value = office.officeName || '';
            document.getElementById('department').value = office.department || '';
            document.getElementById('contactPerson').value = office.contactPerson || '';
            document.getElementById('contactEmail').value = office.contactEmail || '';
            document.getElementById('totalEmployees').value = office.totalEmployees || '';
            document.getElementById('pantryStatus').value = office.pantryStatus || '';
            document.getElementById('restroomsStatus').value = office.restroomsStatus || '';
            document.getElementById('meetingRoomsStatus').value = office.meetingRoomsStatus || '';
            document.getElementById('eventsStatus').value = office.eventsStatus || '';
            document.getElementById('premisesStatus').value = office.premisesStatus || '';
            document.getElementById('certificateDate').value = office.certificateDate || '';
        }

        async function deleteOffice(id) {
            if (confirm('Are you sure?')) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                loadOffices();
            }
        }

        async function exportToCSV() {
            const res = await fetch(API_URL);
            const offices = await res.json();
            if (!offices.length) return alert("No data to export");

            const headers = Object.keys(offices[0]).filter(h => h !== '__v'); // remove Mongo __v field
            const csvRows = [];
            csvRows.push(headers.join(','));

            offices.forEach(o => {
                const row = headers.map(h => {
                    let val = o[h] || '';

                    // Format date if it's in ISO format
                    if (h.toLowerCase().includes('date') && val) {
                        const d = new Date(val);
                        if (!isNaN(d)) {
                            val = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
                        }
                    }

                    // Escape quotes for CSV
                    val = String(val).replace(/"/g, '""');
                    return `"${val}"`;
                });
                csvRows.push(row.join(','));
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'offices.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function exportToJSON() {
            const res = await fetch(API_URL);
            const offices = await res.json();
            if (!offices.length) return alert("No data to export");

            const blob = new Blob([JSON.stringify(offices, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'offices.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('officeForm').addEventListener('submit', saveOffice);
        window.onload = loadOffices;
    </script>

</body>
</html>
